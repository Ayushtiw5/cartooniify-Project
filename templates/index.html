<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Anime/Cartoon Filter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--accent:#5b8cff;--muted:#666;--card:#fff}
    body{font-family:Inter,ui-sans-serif,system-ui,Arial;margin:18px;max-width:1100px}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:1.4rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .panel{background:var(--card);border:1px solid #e6e9ef;padding:14px;border-radius:12px}
    .drop{border:2px dashed #e2e8f0;border-radius:10px;padding:18px;text-align:center;cursor:pointer}
    .drop.dragover{background:#f6f9ff;border-color:var(--accent)}
    img.preview{max-width:100%;border-radius:8px;display:block;margin:8px auto}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:0.9rem;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
    .row{display:flex;gap:10px;align-items:center}
    .small{font-size:0.85rem;color:var(--muted)}
    progress{width:100%}
    .result-row{display:flex;gap:12px;flex-direction:column}
    @media(min-width:900px){.result-row{flex-direction:row}}
  </style>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const fileInput=document.getElementById('file')
      const drop=document.getElementById('drop')
      const preview=document.getElementById('preview')
      const processBtn=document.getElementById('process')
      const progressBar=document.getElementById('progress')
      const outImg=document.getElementById('output')
      const inputImg=document.getElementById('input')
      const modeSelect=document.getElementById('mode')
      const satSlider=document.getElementById('sat')
      const dilSlider=document.getElementById('dilate')

      function setPreview(file){
        const url=URL.createObjectURL(file)
        preview.src=url
        preview.style.display='block'
      }

      drop.addEventListener('click',()=>fileInput.click())
      drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('dragover')})
      drop.addEventListener('dragleave',e=>{drop.classList.remove('dragover')})
      drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('dragover');const f=e.dataTransfer.files[0];if(f){fileInput.files=f?(function(){const dt=new DataTransfer();dt.items.add(f);return dt.files})():null;setPreview(f)}})

      fileInput.addEventListener('change',()=>{const f=fileInput.files[0];if(f)setPreview(f)})

      processBtn.addEventListener('click',()=>{
        const f=fileInput.files[0]
        if(!f){alert('Please choose an image first');return}
        processBtn.disabled=true;processBtn.textContent='Processing...'
        progressBar.value=0;progressBar.hidden=false

  const form=new FormData()
  form.append('image',f)
  form.append('mode',modeSelect.value)
  form.append('sat',satSlider.value)
  form.append('dilate',dilSlider.value)
  form.append('sigmaColor',document.getElementById('sigmaColor').value)
  form.append('sigmaSpace',document.getElementById('sigmaSpace').value)
  form.append('blockSize',document.getElementById('blockSize').value)
  form.append('C',document.getElementById('C').value)
  form.append('scale',document.getElementById('scale').value)
  form.append('ksize',document.getElementById('ksize').value)
  form.append('x_sigma',document.getElementById('x_sigma').value)

        const xhr=new XMLHttpRequest()
        xhr.open('POST','/process')
        xhr.responseType='json'
        xhr.upload.onprogress=(e)=>{if(e.lengthComputable)progressBar.value=e.loaded/e.total}
        xhr.onload=()=>{
          processBtn.disabled=false;processBtn.textContent='Process'
          progressBar.hidden=true
          if(xhr.status===200 && xhr.response){
            const data=xhr.response
            inputImg.src=data.input_url
            outImg.src=data.output_url
            document.getElementById('resultCard').style.display='block'
            // link to download route (attachment)
            const outName = data.output_url.split('/').pop()
            document.getElementById('download').href = '/download/' + outName
            document.getElementById('download').download = outName
            // refresh gallery
            if(typeof loadGallery === 'function') loadGallery()
          }else{
            alert((xhr.response && xhr.response.error) || 'Processing failed')
          }
        }
        xhr.onerror=()=>{processBtn.disabled=false;processBtn.textContent='Process';progressBar.hidden=true;alert('Network error')}
        xhr.send(form)
      })

      // If server rendered images (fallback), show them
      const serverIn=document.getElementById('server_in')
      const serverOut=document.getElementById('server_out')
      if(serverIn && serverIn.value){inputImg.src=serverIn.value;document.getElementById('resultCard').style.display='block'}
      if(serverOut && serverOut.value){outImg.src=serverOut.value;document.getElementById('download').href=serverOut.value}
    })
  </script>
</head>
<body>
  <header>
    <h1>Anime / Cartoon Filter</h1>
  </header>

  <div class="grid">
    <div class="panel">
      <div id="drop" class="drop">
        <div style="font-weight:600">Drag & drop an image here</div>
        <div class="small">or click to browse â€¢ PNG/JPG recommended</div>
        <img id="preview" class="preview" style="display:none" />
      </div>

      <div style="margin-top:12px" class="controls">
        <input id="file" type="file" accept="image/*" style="display:none" name="image">
        <div class="row">
          <label for="mode">Style</label>
          <select id="mode">
            <option value="anime">Anime (stylized)</option>
            <option value="cartoon">Cartoon (classic)</option>
            <option value="sketch">Sketch (pencil)</option>
            <option value="xdog">xDoG / Ink</option>
          </select>
        </div>

        <div class="row" style="align-items:center">
          <label for="sat">Saturation</label>
          <input id="sat" type="range" min="0.6" max="2.0" step="0.05" value="1.15">
          <span class="small">(<span id="sat_val">1.15</span>x)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="dilate">Edge Thickness</label>
          <input id="dilate" type="range" min="0" max="4" step="1" value="1">
          <span class="small">(<span id="dil_val">1</span>)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="sigmaColor">Bilateral sigmaColor</label>
          <input id="sigmaColor" type="range" min="10" max="200" step="5" value="75">
          <span class="small">(<span id="sc_val">75</span>)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="sigmaSpace">Bilateral sigmaSpace</label>
          <input id="sigmaSpace" type="range" min="10" max="200" step="5" value="75">
          <span class="small">(<span id="ss_val">75</span>)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="blockSize">Adaptive blockSize (odd)</label>
          <input id="blockSize" type="range" min="3" max="51" step="2" value="9">
          <span class="small">(<span id="bs_val">9</span>)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="C">Adaptive C</label>
          <input id="C" type="range" min="-20" max="20" step="1" value="5">
          <span class="small">(<span id="C_val">5</span>)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="scale">Processing scale</label>
          <input id="scale" type="range" min="0.25" max="1.0" step="0.25" value="1.0">
          <span class="small">(<span id="scale_val">1.0</span>x)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="ksize">Sketch blur ksize</label>
          <input id="ksize" type="range" min="3" max="51" step="2" value="21">
          <span class="small">(<span id="ksize_val">21</span>)</span>
        </div>

        <div class="row" style="align-items:center">
          <label for="x_sigma">xDoG sigma</label>
          <input id="x_sigma" type="range" min="0.5" max="3.0" step="0.1" value="1.0">
          <span class="small">(<span id="xs_val">1.0</span>)</span>
        </div>

        <div style="margin-top:8px">
          <button id="process" class="btn">Process</button>
          <a id="download" class="btn ghost" style="margin-left:8px;display:inline-block" download>Download</a>
        </div>

        <div style="margin-top:8px">
          <progress id="progress" hidden value="0" max="1"></progress>
        </div>
      </div>
    </div>

    <div class="panel result-row">
      <div id="resultCard" style="display:none;flex:1">
        <h3>Original</h3>
        <img id="input" src="" alt="original" style="max-height:360px;object-fit:contain">
      </div>
      <div id="resultCard2" style="display:block;flex:1">
        <h3>Result</h3>
        <img id="output" src="" alt="result" style="max-height:360px;object-fit:contain">
      </div>
    </div>
  </div>

  <!-- hidden inputs populated by server-side fallback -->
  <input type="hidden" id="server_in" value="{{ input_url|default('') }}">
  <input type="hidden" id="server_out" value="{{ output_url|default('') }}">

  <script>
    // link sliders with labels
    const sat=document.getElementById('sat'), sat_val=document.getElementById('sat_val')
    const dil=document.getElementById('dilate'), dil_val=document.getElementById('dil_val')
    if(sat){sat.addEventListener('input',()=>sat_val.textContent=sat.value)}
    if(dil){dil.addEventListener('input',()=>dil_val.textContent=dil.value)}
    // additional control labels
    const sc=document.getElementById('sigmaColor'), sc_val=document.getElementById('sc_val')
    const ss=document.getElementById('sigmaSpace'), ss_val=document.getElementById('ss_val')
    const bs=document.getElementById('blockSize'), bs_val=document.getElementById('bs_val')
    const C=document.getElementById('C'), C_val=document.getElementById('C_val')
    const scale=document.getElementById('scale'), scale_val=document.getElementById('scale_val')
    const ksize=document.getElementById('ksize'), ksize_val=document.getElementById('ksize_val')
    const xs=document.getElementById('x_sigma'), xs_val=document.getElementById('xs_val')
    if(sc){sc.addEventListener('input',()=>sc_val.textContent=sc.value)}
    if(ss){ss.addEventListener('input',()=>ss_val.textContent=ss.value)}
    if(bs){bs.addEventListener('input',()=>bs_val.textContent=bs.value)}
    if(C){C.addEventListener('input',()=>C_val.textContent=C.value)}
    if(scale){scale.addEventListener('input',()=>scale_val.textContent=scale.value)}
    if(ksize){ksize.addEventListener('input',()=>ksize_val.textContent=ksize.value)}
    if(xs){xs.addEventListener('input',()=>xs_val.textContent=xs.value)}

    // gallery loader
    async function loadGallery(){
      try{
        const res = await fetch('/gallery')
        if(!res.ok) return
        const items = await res.json()
        const container = document.getElementById('gallery')
        if(!container) return
        container.innerHTML = ''
        items.slice(0,12).forEach(it=>{
          const card = document.createElement('div')
          card.className = 'panel'
          card.style.marginBottom = '10px'
          card.innerHTML = `<div style="font-size:0.9rem;color:#666;margin-bottom:6px">${new Date(it.time).toLocaleString()}</div><a href="/download/${it.output.split('/').pop()}" download><img src="/static/${it.output}" style="max-width:100%;height:120px;object-fit:cover;border-radius:6px"></a>`
          container.appendChild(card)
        })
      }catch(e){console.warn('gallery',e)}
    }
    // initial gallery load
    document.addEventListener('DOMContentLoaded',()=>loadGallery())
  </script>

  <h3 style="margin-top:18px">History</h3>
  <div id="gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:8px"></div>
</body>
</html>